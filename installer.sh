#!/usr/bin/bash

# helper function
function ensure_dir {
    if [[ ! -d "webui/$1" ]]
    then
        mv "source/$1" "webui/$1"
    fi
}

if [[ -z "$NO_PREPARE_DIR" ]]
then
    # create (might) needed directories that not in sdwebui repo
    for dir in .cache config_states GFPGAN log outputs repositories venv
    do
        mkdir -p "webui/$dir"
    done

    # create settings if needed
    touch webui/config.json webui/ui-config.json

    # clone the repo and move the needed directories
    git clone --depth 1 https://github.com/AUTOMATIC1111/stable-diffusion-webui source
    for dir in configs embeddings extensions localizations models scripts textual_inversion_templates
    do
        ensure_dir "$dir"
    done
    rm -fr source
fi

echo 'IyBDb21tYW5kbGluZSBhcmd1bWVudHMgZm9yIHdlYnVpLnB5LCBmb3IgZXhhbXBsZTogZXhwb3J0IENPTU1BTkRMSU5FX0FSR1M9Ii0tbWVkdnJhbSAtLW9wdC1zcGxpdC1hdHRlbnRpb24iCiMgQ09NTUFORExJTkVfQVJHUz0iIgoKIyBpbnN0YWxsIGNvbW1hbmQgZm9yIHRvcmNoCiMgVE9SQ0hfQ09NTUFORD0icGlwIGluc3RhbGwgdG9yY2g9PTEuMTIuMStjdTExMyAtLWV4dHJhLWluZGV4LXVybCBodHRwczovL2Rvd25sb2FkLnB5dG9yY2gub3JnL3dobC9jdTExMyIKCiMgUmVxdWlyZW1lbnRzIGZpbGUgdG8gdXNlIGZvciBzdGFibGUtZGlmZnVzaW9uLXdlYnVpCiMgUkVRU19GSUxFPSJyZXF1aXJlbWVudHNfdmVyc2lvbnMudHh0IgoKIyBVbmNvbW1lbnQgdG8gZW5hYmxlIGFjY2VsZXJhdGVkIGxhdW5jaAojIEFDQ0VMRVJBVEU9IlRydWUiCiMgVW5jb21tZW50IHRvIGRpc2FibGUgVENNYWxsb2MKIyBOT19UQ01BTExPQz0iVHJ1ZSIKCiMgc29tZSBoYWNrcywgdXNlIG9ubHkgaWYgeW91IGtub3cgd2hhdCB5b3UgYXJlIGRvaW5nCiMgUFJPVE9DT0xfQlVGRkVSU19QWVRIT05fSU1QTEVNRU5UQVRJT049cHl0aG9uCiMgUFlUT1JDSF9DVURBX0FMTE9DX0NPTkY9Z2FyYmFnZV9jb2xsZWN0aW9uX3RocmVzaG9sZDowLjksbWF4X3NwbGl0X3NpemVfbWI6NTEyCgo=' | base64 -d > webui/.env
echo "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" | base64 -d | tar zxvf -
mv docker-compose.tmpl.yml docker-compose.yml
sed -i "s/#UID#/$(id -u)/" docker-compose.yml
sed -i "s/#GID#/$(id -g)/" docker-compose.yml
echo "installation completed"
echo
echo
echo "H4sIAAAAAAAAA62RO28bMRCEe/6KwTVpzAsSAy4UuHD8QgBbBiQnrbFHrnSEj6TAh6zLr88SSho7aQKzYLHL2Z35+Hj35Wql1E1MsGw4FCx/wFCyeaGgwdYVvPBQ3ceewx4ULDIXXD7c318sr+6+La+fLla36/NO68nlwgFac6BhYu1CZlMTaz5IPbsYNBnDOcuTwyYmzyl3bUmqAZ2N5pkTTPS7mBl11x1dxclK+Y8plJEKRsqgIdaCs1vsE/n/9urZNv17mj4/HvU905YXSn3qcVlzid795Nf2jnr9W9/PfkKJ2EiOOdaEwGx79bnH1+omC+dlIl5cGd9sHtqDrlenPdaFUhFOLOHT3pl/KOoO2nYnaMzcJHvpWRTRM4prV1QAhEYhaVrecbAcjOPcK/UYZUzYuK2AQsMzcaIiw+W//iaBp1ClOJ+0XB+k25KB1F5A6MRkZ+SRpT7MDWxwYfvGcAOudfJHhhgojxJY/QJ3Dp91wQIAAA==" | base64 -d | gunzip
